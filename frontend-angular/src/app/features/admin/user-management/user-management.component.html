<div class="user-management">
  <div class="header">
    <h2>Gestión de Usuarios</h2>
    <button (click)="loadUsers()" class="btn-refresh" [disabled]="loading()">Actualizar</button>
  </div>

  @if (errorMessage()) {
    <div class="alert alert-error">{{ errorMessage() }}</div>
  }

  @if (successMessage()) {
    <div class="alert alert-success">{{ successMessage() }}</div>
  }

  <div class="filters">
    <div class="basic-filters">
      <input 
        type="text" 
        placeholder="Buscar por nombre o email..." 
        [value]="searchTerm()"
        (input)="onSearchChange($any($event.target).value)"
        class="search-input"
      />
      <button (click)="toggleAdvancedSearch()" class="btn-toggle-search">
        {{ showAdvancedSearch() ? 'Ocultar' : 'Mostrar' }} Búsqueda Avanzada
      </button>
      @if (searchTerm()) {
        <button (click)="clearFilters()" class="btn-clear">Limpiar filtros</button>
      }
    </div>

    @if (showAdvancedSearch()) {
      <div class="modal-overlay" (click)="closeAdvancedSearch()">
        <div class="advanced-search-modal" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h3>Búsqueda Avanzada</h3>
            <button class="btn-close" (click)="closeAdvancedSearch()" aria-label="Cerrar">×</button>
          </div>
          <div class="modal-body">
            <div class="search-grid">
              <div class="search-field">
                <label>Email:</label>
                <input 
                  type="text" 
                  [ngModel]="searchRequest().email"
                  (ngModelChange)="updateSearchField('email', $event)"
                  placeholder="email@ejemplo.com"
                />
              </div>
              <div class="search-field">
                <label>Documento:</label>
                <input 
                  type="text" 
                  [ngModel]="searchRequest().documentNumber"
                  (ngModelChange)="updateSearchField('documentNumber', $event)"
                  placeholder="Número de documento"
                />
              </div>
              <div class="search-field">
                <label>Teléfono:</label>
                <input 
                  type="text" 
                  [ngModel]="searchRequest().phone"
                  (ngModelChange)="updateSearchField('phone', $event)"
                  placeholder="Teléfono"
                />
              </div>
              <div class="search-field">
                <label>Puntos Mínimos:</label>
                <input 
                  type="number" 
                  [ngModel]="searchRequest().minPoints"
                  (ngModelChange)="updateSearchField('minPoints', $event)"
                  placeholder="0"
                  min="0"
                />
              </div>
              <div class="search-field">
                <label>Puntos Máximos:</label>
                <input 
                  type="number" 
                  [ngModel]="searchRequest().maxPoints"
                  (ngModelChange)="updateSearchField('maxPoints', $event)"
                  placeholder="999999"
                  min="0"
                />
              </div>
              <div class="search-field">
                <label>Pedidos Mínimos:</label>
                <input 
                  type="number" 
                  [ngModel]="searchRequest().minOrders"
                  (ngModelChange)="updateSearchField('minOrders', $event)"
                  placeholder="0"
                  min="0"
                />
              </div>
              <div class="search-field">
                <label>Pedidos Máximos:</label>
                <input 
                  type="number" 
                  [ngModel]="searchRequest().maxOrders"
                  (ngModelChange)="updateSearchField('maxOrders', $event)"
                  placeholder="999999"
                  min="0"
                />
              </div>
              <div class="search-field">
                <label>Gastado Mínimo:</label>
                <input 
                  type="number" 
                  [ngModel]="searchRequest().minSpent"
                  (ngModelChange)="updateSearchField('minSpent', $event)"
                  placeholder="0"
                  min="0"
                  step="0.01"
                />
              </div>
              <div class="search-field">
                <label>Gastado Máximo:</label>
                <input 
                  type="number" 
                  [ngModel]="searchRequest().maxSpent"
                  (ngModelChange)="updateSearchField('maxSpent', $event)"
                  placeholder="999999"
                  min="0"
                  step="0.01"
                />
              </div>
              <div class="search-field">
                <label>Ordenar por:</label>
                <select 
                  [ngModel]="searchRequest().sortBy || 'id'"
                  (ngModelChange)="updateSearchField('sortBy', $event)"
                >
                  <option value="id">ID</option>
                  <option value="name">Nombre</option>
                  <option value="email">Email</option>
                  <option value="points">Puntos</option>
                  <option value="totalSpent">Total Gastado</option>
                </select>
              </div>
              <div class="search-field">
                <label>Dirección:</label>
                <select 
                  [ngModel]="searchRequest().sortDirection || 'ASC'"
                  (ngModelChange)="updateSearchField('sortDirection', $event)"
                >
                  <option value="ASC">Ascendente</option>
                  <option value="DESC">Descendente</option>
                </select>
              </div>
            </div>
          </div>
          <div class="modal-actions">
            <button class="btn-clear-filters" (click)="clearAdvancedFilters()">Limpiar</button>
            <button class="btn-cancel-search" (click)="closeAdvancedSearch()">Cancelar</button>
            <button class="btn-apply-search" (click)="applyAdvancedSearch()">Aplicar Búsqueda</button>
          </div>
        </div>
      </div>
    }
  </div>

  <!-- Información de paginación -->
  <div class="pagination-info">
    <span>Mostrando {{ users().length }} de {{ totalElements() }} usuarios</span>
    <select 
      [value]="pageSize()"
      (change)="onPageSizeChange(+$any($event.target).value)"
      class="page-size-select"
    >
      <option [value]="10">10 por página</option>
      <option [value]="20">20 por página</option>
      <option [value]="50">50 por página</option>
      <option [value]="100">100 por página</option>
    </select>
  </div>

  @if (loading() && users().length === 0) {
    <div class="loading">Cargando usuarios...</div>
  } @else {
    <div class="users-container">
      <div class="users-list">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>Email</th>
              <th>Teléfono</th>
              <th>Pedidos</th>
              <th>Total Gastado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            @for (user of users(); track user.id) {
              <tr>
                <td>{{ user.id }}</td>
                <td>
                  <div class="user-name">{{ user.name }} {{ user.lastName }}</div>
                </td>
                <td>
                  <div class="user-email">{{ user.email }}</div>
                </td>
                <td>{{ user.phone || 'N/A' }}</td>
                <td>{{ user.numberOfOrders || 0 }}</td>
                <td>{{ user.totalSpent | formatCurrency }}</td>
                <td>
                  <div class="action-buttons">
                    <button class="btn-delete" (click)="deleteUser(user.id); $event.stopPropagation()" [disabled]="loading()">Eliminar</button>
                  </div>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>

      <!-- Controles de paginación -->
      @if (totalPages() > 1) {
        <div class="pagination-controls">
          <button 
            (click)="previousPage()" 
            [disabled]="currentPage() === 0"
            class="btn-pagination"
          >
            Anterior
          </button>
          <span class="page-info">
            Página {{ currentPage() + 1 }} de {{ totalPages() }}
          </span>
          <button 
            (click)="nextPage()" 
            [disabled]="currentPage() >= totalPages() - 1"
            class="btn-pagination"
          >
            Siguiente
          </button>
        </div>
      }

    </div>
  }
</div>
