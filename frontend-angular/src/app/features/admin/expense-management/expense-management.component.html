<div class="expense-management">
  <div class="header">
    <h2>Gesti√≥n de Gastos</h2>
    <button 
      class="btn-add" 
      (click)="toggleForm()"
      [disabled]="loading() || showForm()"
    >
      + Registrar Gasto
    </button>
  </div>

  @if (errorMessage()) {
    <div class="alert alert-error">{{ errorMessage() }}</div>
  }

  @if (successMessage()) {
    <div class="alert alert-success">{{ successMessage() }}</div>
  }

  <!-- Formulario de gasto -->
  @if (showForm()) {
    <div class="expense-form">
      <h3>{{ editingExpense() ? 'Editar Gasto' : 'Registrar Nuevo Gasto' }}</h3>
      
      <form [formGroup]="expenseForm" (ngSubmit)="onSubmit()">
        <div class="form-row">
          <div class="form-group">
            <label for="description">Descripci√≥n *</label>
            <input 
              type="text" 
              id="description" 
              formControlName="description"
              [class.error]="expenseForm.get('description')?.invalid && expenseForm.get('description')?.touched"
              [disabled]="loading()"
            />
            @if (expenseForm.get('description')?.invalid && expenseForm.get('description')?.touched) {
              <small class="error-text">{{ getErrorMessage('description') }}</small>
            }
          </div>

          <div class="form-group">
            <label for="category">Categor√≠a *</label>
            <select 
              id="category" 
              formControlName="category"
              [class.error]="expenseForm.get('category')?.invalid && expenseForm.get('category')?.touched"
              [disabled]="loading()"
            >
              <option value="">Selecciona una categor√≠a</option>
              @for (cat of categories; track cat) {
                <option [value]="cat">{{ cat }}</option>
              }
            </select>
            @if (expenseForm.get('category')?.invalid && expenseForm.get('category')?.touched) {
              <small class="error-text">{{ getErrorMessage('category') }}</small>
            }
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="amount">Monto *</label>
            <input 
              type="number" 
              id="amount" 
              formControlName="amount"
              min="0.01"
              step="0.01"
              [class.error]="expenseForm.get('amount')?.invalid && expenseForm.get('amount')?.touched"
              [disabled]="loading()"
            />
            @if (expenseForm.get('amount')?.invalid && expenseForm.get('amount')?.touched) {
              <small class="error-text">{{ getErrorMessage('amount') }}</small>
            }
          </div>

          <div class="form-group">
            <label for="expenseDate">Fecha *</label>
            <input 
              type="date" 
              id="expenseDate" 
              formControlName="expenseDate"
              [class.error]="expenseForm.get('expenseDate')?.invalid && expenseForm.get('expenseDate')?.touched"
              [disabled]="loading()"
            />
            @if (expenseForm.get('expenseDate')?.invalid && expenseForm.get('expenseDate')?.touched) {
              <small class="error-text">{{ getErrorMessage('expenseDate') }}</small>
            }
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="paymentMethod">M√©todo de Pago</label>
            <select 
              id="paymentMethod" 
              formControlName="paymentMethod"
              [disabled]="loading()"
            >
              <option value="">Selecciona un m√©todo</option>
              @for (method of paymentMethods; track method) {
                <option [value]="method">{{ method }}</option>
              }
            </select>
          </div>
        </div>

        <div class="form-group">
          <label for="notes">Notas</label>
          <textarea 
            id="notes" 
            formControlName="notes"
            rows="3"
            [disabled]="loading()"
          ></textarea>
        </div>

        <div class="form-group">
          <label for="receiptUrl">URL del Comprobante</label>
          <input 
            type="url" 
            id="receiptUrl" 
            formControlName="receiptUrl"
            placeholder="https://ejemplo.com/comprobante.pdf"
            [disabled]="loading()"
          />
        </div>

        <div class="form-actions">
          <button 
            type="submit" 
            class="btn-save"
            [disabled]="loading() || expenseForm.invalid"
          >
            {{ loading() ? 'Guardando...' : (editingExpense() ? 'Actualizar' : 'Registrar') }}
          </button>
          <button 
            type="button" 
            class="btn-cancel" 
            (click)="toggleForm()"
            [disabled]="loading()"
          >
            Cancelar
          </button>
        </div>
      </form>
    </div>
  }

  <!-- Filtros y b√∫squeda -->
  <div class="filters-section">
    <!-- Primera fila: Filtros principales -->
    <div class="filters-row">
      <input 
        type="text" 
        placeholder="Buscar gastos..." 
        [value]="searchTerm()"
        (input)="onSearchChange($any($event.target).value)"
        [disabled]="loading()"
        class="search-input"
      />
      <select 
        [value]="selectedCategory()"
        (change)="onCategoryChange($any($event.target).value)"
        [disabled]="loading()"
        class="category-select"
      >
        <option value="">Todas las categor√≠as</option>
        @for (cat of categories; track cat) {
          <option [value]="cat">{{ cat }}</option>
        }
      </select>
      <div class="date-group">
        <label for="startDate" class="date-label">Desde:</label>
        <input 
          type="date" 
          id="startDate"
          [value]="startDate()"
          (change)="startDate.set($any($event.target).value); onDateRangeChange()"
          [disabled]="loading()"
          class="date-input"
        />
      </div>
      <div class="date-group">
        <label for="endDate" class="date-label">Hasta:</label>
        <input 
          type="date" 
          id="endDate"
          [value]="endDate()"
          (change)="endDate.set($any($event.target).value); onDateRangeChange()"
          [disabled]="loading()"
          class="date-input"
        />
      </div>
    </div>

    <!-- Segunda fila: Botones de acci√≥n -->
    <div class="actions-row">
      <button (click)="toggleAdvancedSearch()" class="btn-toggle-search">
        {{ showAdvancedSearch() ? 'Ocultar' : 'Mostrar' }} B√∫squeda Avanzada
      </button>
      @if (searchTerm() || selectedCategory() || startDate() || endDate() || hasActiveFilters()) {
        <button 
          class="btn-clear"
          (click)="clearFilters()"
          [disabled]="loading()"
        >
          Limpiar filtros
        </button>
      }
      <button 
        class="btn-export"
        (click)="exportToExcel()"
        [disabled]="loading()"
      >
        üìä Exportar
      </button>
    </div>

    @if (showAdvancedSearch()) {
      <div class="modal-overlay" (click)="closeAdvancedSearch()">
        <div class="advanced-search-modal" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h3>B√∫squeda Avanzada</h3>
            <button class="btn-close" (click)="closeAdvancedSearch()" aria-label="Cerrar">√ó</button>
          </div>
          <div class="modal-body">
            <div class="search-grid">
              <div class="search-field">
                <label>Monto M√≠nimo:</label>
                <input 
                  type="number" 
                  [ngModel]="searchRequest().minAmount"
                  (ngModelChange)="updateSearchField('minAmount', $event)"
                  placeholder="0"
                  step="0.01"
                  min="0"
                />
              </div>
              <div class="search-field">
                <label>Monto M√°ximo:</label>
                <input 
                  type="number" 
                  [ngModel]="searchRequest().maxAmount"
                  (ngModelChange)="updateSearchField('maxAmount', $event)"
                  placeholder="999999"
                  step="0.01"
                  min="0"
                />
              </div>
              <div class="search-field">
                <label>M√©todo de Pago:</label>
                <select 
                  [ngModel]="searchRequest().paymentMethod"
                  (ngModelChange)="updateSearchField('paymentMethod', $event)"
                >
                  <option value="">Todos</option>
                  @for (method of paymentMethods; track method) {
                    <option [value]="method">{{ method }}</option>
                  }
                </select>
              </div>
              <div class="search-field">
                <label>Ordenar por:</label>
                <select 
                  [ngModel]="searchRequest().sortBy"
                  (ngModelChange)="updateSearchField('sortBy', $event)"
                >
                  <option value="">Sin ordenar</option>
                  <option value="expenseDate">Fecha</option>
                  <option value="amount">Monto</option>
                  <option value="category">Categor√≠a</option>
                  <option value="description">Descripci√≥n</option>
                </select>
              </div>
              <div class="search-field">
                <label>Direcci√≥n:</label>
                <select 
                  [ngModel]="searchRequest().sortDirection"
                  (ngModelChange)="updateSearchField('sortDirection', $event)"
                >
                  <option value="DESC">Descendente</option>
                  <option value="ASC">Ascendente</option>
                </select>
              </div>
            </div>
          </div>
          <div class="modal-actions">
            <button class="btn-clear-filters" (click)="clearAdvancedFilters()" type="button">Limpiar</button>
            <button class="btn-cancel-search" (click)="closeAdvancedSearch()" type="button">Cancelar</button>
            <button class="btn-apply-search" (click)="applyAdvancedSearch()" [disabled]="loading()" type="button">Aplicar B√∫squeda</button>
          </div>
        </div>
      </div>
    }

    <div class="pagination-info">
      <span>Mostrando {{ expenses().length }} de {{ totalElements() }} gastos</span>
      <span class="total-expenses">Total: {{ getTotalExpenses() | formatCurrency }}</span>
      <select 
        [value]="pageSize()"
        (change)="onPageSizeChange(+$any($event.target).value)"
        class="page-size-select"
      >
        <option [value]="10">10 por p√°gina</option>
        <option [value]="20">20 por p√°gina</option>
        <option [value]="50">50 por p√°gina</option>
        <option [value]="100">100 por p√°gina</option>
      </select>
    </div>
  </div>

  <!-- Lista de gastos -->
  @if (loading() && expenses().length === 0) {
    <div class="loading">Cargando gastos...</div>
  } @else if (!loading() && expenses().length === 0) {
    <div class="empty-state">
      @if (searchTerm() || selectedCategory() || startDate() || endDate()) {
        <p>No se encontraron gastos que coincidan con los filtros.</p>
      } @else {
        <p>No hay gastos registrados. Registra tu primer gasto para comenzar.</p>
      }
    </div>
  } @else {
    <div class="expenses-list">
      <table class="expenses-table">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Descripci√≥n</th>
            <th>Categor√≠a</th>
            <th>Monto</th>
            <th>M√©todo de Pago</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          @for (expense of expenses(); track expense.id) {
            <tr>
              <td>{{ expense.expenseDate | date:'shortDate' }}</td>
              <td>{{ expense.description }}</td>
              <td><span class="category-badge">{{ expense.category }}</span></td>
              <td class="amount">{{ expense.amount | formatCurrency }}</td>
              <td>{{ expense.paymentMethod || '-' }}</td>
              <td class="actions">
                <button 
                  class="btn-edit"
                  (click)="toggleForm(expense)"
                  [disabled]="loading()"
                >
                  Editar
                </button>
                <button 
                  class="btn-delete"
                  (click)="deleteExpense(expense.id)"
                  [disabled]="loading()"
                >
                  Eliminar
                </button>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>

    <!-- Controles de paginaci√≥n -->
    @if (totalPages() > 1) {
      <div class="pagination-controls">
        <button 
          (click)="previousPage()" 
          [disabled]="currentPage() === 0"
          class="btn-pagination"
        >
          Anterior
        </button>
        <span class="page-info">
          P√°gina {{ currentPage() + 1 }} de {{ totalPages() }}
        </span>
        <button 
          (click)="nextPage()" 
          [disabled]="currentPage() >= totalPages() - 1"
          class="btn-pagination"
        >
          Siguiente
        </button>
      </div>
    }
  }
</div>

