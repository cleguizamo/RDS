<div class="subcategory-management">
  <div class="header">
    <h2>Gestión de Subcategorías</h2>
    <button 
      class="btn-add" 
      (click)="toggleForm()"
      [disabled]="loading() || showForm()"
    >
      + Agregar Subcategoría
    </button>
  </div>

  @if (errorMessage()) {
    <div class="alert alert-error">{{ errorMessage() }}</div>
  }

  @if (successMessage()) {
    <div class="alert alert-success">{{ successMessage() }}</div>
  }

  <!-- Formulario de subcategoría -->
  @if (showForm()) {
    <div class="subcategory-form">
      <h3>{{ editingSubCategory() ? 'Editar Subcategoría' : 'Agregar Nueva Subcategoría' }}</h3>
      
      <form [formGroup]="subCategoryForm" (ngSubmit)="onSubmit()">
        <div class="form-group">
          <label for="categoryId">Categoría *</label>
          @if (loadingCategories()) {
            <select id="categoryId" formControlName="categoryId" [disabled]="true">
              <option>Cargando categorías...</option>
            </select>
          } @else {
            <select 
              id="categoryId" 
              formControlName="categoryId"
              [class.error]="subCategoryForm.get('categoryId')?.invalid && subCategoryForm.get('categoryId')?.touched"
              [disabled]="loading() || categories().length === 0"
            >
              <option [value]="0">Seleccionar categoría</option>
              @for (cat of categories(); track cat.id) {
                <option [value]="cat.id">{{ cat.name }}</option>
              }
            </select>
            @if (subCategoryForm.get('categoryId')?.invalid && subCategoryForm.get('categoryId')?.touched) {
              <small class="error-text">{{ getErrorMessage('categoryId') }}</small>
            }
          }
        </div>

        <div class="form-group">
          <label for="name">Nombre *</label>
          <input 
            type="text" 
            id="name" 
            formControlName="name"
            [class.error]="subCategoryForm.get('name')?.invalid && subCategoryForm.get('name')?.touched"
            [disabled]="loading()"
          />
          @if (subCategoryForm.get('name')?.invalid && subCategoryForm.get('name')?.touched) {
            <small class="error-text">{{ getErrorMessage('name') }}</small>
          }
        </div>

        <div class="form-group">
          <label for="description">Descripción</label>
          <textarea 
            id="description" 
            formControlName="description"
            rows="3"
            [disabled]="loading()"
          ></textarea>
        </div>

        <div class="form-actions">
          <button 
            type="submit" 
            class="btn-save"
            [disabled]="loading() || subCategoryForm.invalid"
          >
            {{ loading() ? 'Guardando...' : (editingSubCategory() ? 'Actualizar' : 'Crear') }}
          </button>
          <button 
            type="button" 
            class="btn-cancel" 
            (click)="toggleForm()"
            [disabled]="loading()"
          >
            Cancelar
          </button>
        </div>
      </form>
    </div>
  }

  <!-- Filtros -->
  <div class="filters">
    <div class="search-bar">
      <input 
        type="text" 
        placeholder="Buscar subcategorías..." 
        [(ngModel)]="searchTerm"
        (input)="onSearchChange(searchTerm())"
        [disabled]="loading()"
      />
    </div>
    <div class="category-filter">
      <select 
        [(ngModel)]="selectedCategoryFilter"
        (ngModelChange)="onCategoryFilterChange($event)"
        [disabled]="loading() || loadingCategories()"
      >
        <option [value]="0">Todas las categorías</option>
        @for (cat of categories(); track cat.id) {
          <option [value]="cat.id">{{ cat.name }}</option>
        }
      </select>
    </div>
  </div>

  <!-- Lista de subcategorías -->
  @if (loading() && subCategories().length === 0) {
    <div class="loading">Cargando subcategorías...</div>
  } @else if (!loading() && filteredSubCategories().length === 0) {
    <div class="empty-state">
      @if (searchTerm() || selectedCategoryFilter() > 0) {
        <p>No se encontraron subcategorías que coincidan con los filtros.</p>
      } @else {
        <p>No hay subcategorías registradas. Crea tu primera subcategoría para comenzar.</p>
      }
    </div>
  } @else {
    <div class="subcategories-list">
      @for (subCategory of filteredSubCategories(); track subCategory.id) {
        <div class="subcategory-card">
          <div class="subcategory-info">
            <h3>{{ subCategory.name }}</h3>
            <p class="category-name">Categoría: {{ subCategory.categoryName }}</p>
            @if (subCategory.description) {
              <p>{{ subCategory.description }}</p>
            }
            <div class="subcategory-stats">
              <span class="product-count">{{ subCategory.productCount || 0 }} producto(s)</span>
            </div>
          </div>
          <div class="subcategory-actions">
            <button 
              class="btn-edit"
              (click)="toggleForm(subCategory)"
              [disabled]="loading()"
            >
              Editar
            </button>
            <button 
              class="btn-delete"
              (click)="deleteSubCategory(subCategory.id)"
              [disabled]="loading() || (subCategory.productCount || 0) > 0"
              [title]="(subCategory.productCount || 0) > 0 ? 'No se puede eliminar: tiene productos asociados' : 'Eliminar subcategoría'"
            >
              Eliminar
            </button>
          </div>
        </div>
      }
    </div>
  }
</div>

