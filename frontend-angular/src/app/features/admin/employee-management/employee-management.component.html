<div class="employee-management">
  <div class="header">
    <h2>Gesti√≥n de Empleados</h2>
    <button (click)="showAddForm()" class="btn-add" [disabled]="showForm() || loading()">
      {{ showForm() ? 'Cancelar' : 'Agregar Empleado' }}
    </button>
  </div>

  @if (errorMessage()) {
    <div class="alert alert-error">
      <pre>{{ errorMessage() }}</pre>
    </div>
  }

  @if (successMessage()) {
    <div class="alert alert-success">{{ successMessage() }}</div>
  }

  @if (showForm()) {
    <div class="form-card">
      <h3>Agregar Nuevo Empleado</h3>
      <form (ngSubmit)="createEmployee()">
        <div class="form-row">
          <div class="form-group">
            <label>Nombre *</label>
            <input type="text" [(ngModel)]="employeeForm.name" name="name" required />
          </div>
          <div class="form-group">
            <label>Apellido *</label>
            <input type="text" [(ngModel)]="employeeForm.lastName" name="lastName" required />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Tipo de Documento *</label>
            <select [(ngModel)]="employeeForm.documentType" name="documentType" required>
              @for (type of documentTypes; track type) {
                <option [value]="type">{{ type }}</option>
              }
            </select>
          </div>
          <div class="form-group">
            <label>N√∫mero de Documento *</label>
            <input type="text" [(ngModel)]="employeeForm.documentNumber" name="documentNumber" required />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Email *</label>
            <input type="email" [(ngModel)]="employeeForm.email" name="email" required />
          </div>
          <div class="form-group">
            <label>Tel√©fono *</label>
            <input type="text" [(ngModel)]="employeeForm.phone" name="phone" pattern="[0-9]{10}" required />
          </div>
        </div>

        <div class="form-group">
          <label>Contrase√±a *</label>
          <input type="password" [(ngModel)]="employeeForm.password" name="password" minlength="6" required />
          <small>M√≠nimo 6 caracteres, debe incluir letras y n√∫meros</small>
        </div>

        <div class="form-divider">
          <h4>Informaci√≥n de Sueldo (Opcional)</h4>
          <small>Puedes configurar el sueldo ahora o hacerlo despu√©s desde la tabla</small>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Sueldo (COP)</label>
            <input 
              type="number" 
              [(ngModel)]="salaryForm.salary" 
              name="salary"
              min="0"
              step="1000"
              placeholder="Ej: 2000000"
            />
          </div>
          <div class="form-group">
            <label>Frecuencia de Pago</label>
            <select [(ngModel)]="salaryForm.paymentFrequency" name="salaryFrequency">
              @for (frequency of paymentFrequencies; track frequency) {
                <option [value]="frequency">{{ getPaymentFrequencyLabel(frequency) }}</option>
              }
            </select>
          </div>
        </div>

        <div class="form-group">
          <label>D√≠a de Pago (1-31)</label>
          <input 
            type="number" 
            [(ngModel)]="salaryForm.paymentDay" 
            name="paymentDay"
            min="1"
            max="31"
            placeholder="Ej: 1, 15, 30"
          />
          <small>D√≠a del mes en que se realizar√° el pago autom√°tico</small>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn-save" [disabled]="loading()">
            {{ loading() ? 'Guardando...' : 'Crear Empleado' }}
          </button>
          <button type="button" class="btn-cancel" (click)="cancelForm()" [disabled]="loading()">
            Cancelar
          </button>
        </div>
      </form>
    </div>
  }

  <div class="filters">
    <div class="basic-filters">
      <input 
        type="text" 
        placeholder="Buscar por nombre, email, documento o ID..." 
        [value]="searchTerm()"
        (input)="onSearchChange($any($event.target).value)"
        class="search-input"
      />
      <button (click)="toggleAdvancedSearch()" class="btn-toggle-search">
        {{ showAdvancedSearch() ? 'Ocultar' : 'Mostrar' }} B√∫squeda Avanzada
      </button>
      @if (searchTerm() || hasActiveFilters()) {
        <button (click)="clearFilters()" class="btn-clear">Limpiar filtros</button>
      }
    </div>

    @if (showAdvancedSearch()) {
      <div class="modal-overlay" (click)="closeAdvancedSearch()">
        <div class="advanced-search-modal" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h3>B√∫squeda Avanzada</h3>
            <button class="btn-close" (click)="closeAdvancedSearch()" aria-label="Cerrar">√ó</button>
          </div>
          <div class="modal-body">
            <div class="search-grid">
              <div class="search-field">
                <label>Nombre:</label>
                <input 
                  type="text" 
                  [ngModel]="searchRequest().name"
                  (ngModelChange)="updateSearchField('name', $event)"
                  placeholder="Nombre completo"
                />
              </div>
              <div class="search-field">
                <label>Email:</label>
                <input 
                  type="email" 
                  [ngModel]="searchRequest().email"
                  (ngModelChange)="updateSearchField('email', $event)"
                  placeholder="email@ejemplo.com"
                />
              </div>
              <div class="search-field">
                <label>N√∫mero de Documento:</label>
                <input 
                  type="text" 
                  [ngModel]="searchRequest().documentNumber"
                  (ngModelChange)="updateSearchField('documentNumber', $event)"
                  placeholder="N√∫mero de documento"
                />
              </div>
              <div class="search-field">
                <label>Tipo de Documento:</label>
                <select 
                  [ngModel]="searchRequest().documentType"
                  (ngModelChange)="updateSearchField('documentType', $event)"
                >
                  <option [value]="undefined">Todos</option>
                  @for (type of documentTypes; track type) {
                    <option [value]="type">{{ type }}</option>
                  }
                </select>
              </div>
            </div>
          </div>
          <div class="modal-actions">
            <button class="btn-clear-filters" (click)="clearAdvancedFilters()" type="button">Limpiar</button>
            <button class="btn-cancel-search" (click)="closeAdvancedSearch()" type="button">Cancelar</button>
            <button class="btn-apply-search" (click)="applyAdvancedSearch()" [disabled]="loading()" type="button">Aplicar B√∫squeda</button>
          </div>
        </div>
      </div>
    }
  </div>

  @if (loading() && allEmployees().length === 0) {
    <div class="loading">Cargando empleados...</div>
  } @else {
    <div class="employees-table">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Nombre Completo</th>
            <th>Email</th>
            <th>Tel√©fono</th>
            <th>Documento</th>
            <th>Sueldo</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          @for (employee of getFilteredEmployees(); track employee.id) {
            <tr>
              <td>{{ employee.id }}</td>
              <td>{{ employee.name }} {{ employee.lastName }}</td>
              <td>{{ employee.email }}</td>
              <td>{{ employee.phone }}</td>
              <td>{{ employee.documentType }} - {{ employee.documentNumber }}</td>
              <td>
                @if (employee.salary && employee.salary > 0) {
                  <span class="salary-badge">{{ formatCurrency(employee.salary) }}</span>
                  @if (employee.paymentFrequency && employee.paymentDay) {
                    <small class="salary-info">
                      {{ getPaymentFrequencyLabel(employee.paymentFrequency) }} - D√≠a {{ employee.paymentDay }}
                    </small>
                  }
                } @else {
                  <span class="no-salary">No configurado</span>
                }
              </td>
              <td>
                <div class="action-buttons">
                  <button class="btn-salary" (click)="openSalaryModal(employee)" title="Configurar sueldo">
                    üí∞
                  </button>
                  @if (employee.salary) {
                    <button class="btn-history" (click)="openPaymentHistoryModal(employee)" title="Ver historial de pagos">
                      üìã
                    </button>
                  }
                  <button class="btn-delete" (click)="deleteEmployee(employee.id)" title="Eliminar">üóëÔ∏è</button>
                </div>
              </td>
            </tr>
          }
          @if (getFilteredEmployees().length === 0) {
            <tr>
              <td colspan="7" class="no-data">No se encontraron empleados</td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }

  <!-- Modal para configurar sueldo -->
  @if (showSalaryModal()) {
    <div class="modal-overlay" (click)="closeSalaryModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Configurar Sueldo - {{ selectedEmployee()?.name }} {{ selectedEmployee()?.lastName }}</h3>
          <button class="btn-close" (click)="closeSalaryModal()" aria-label="Cerrar">√ó</button>
        </div>
        <div class="modal-body">
          <form (ngSubmit)="updateSalary()">
            <div class="form-group">
              <label>Sueldo (COP) *</label>
              <input 
                type="number" 
                [(ngModel)]="salaryForm.salary" 
                name="salary"
                min="1"
                step="1000"
                required 
                placeholder="Ej: 2000000"
              />
            </div>

            <div class="form-group">
              <label>Frecuencia de Pago *</label>
              <select [(ngModel)]="salaryForm.paymentFrequency" name="paymentFrequency" required>
                @for (frequency of paymentFrequencies; track frequency) {
                  <option [value]="frequency">{{ getPaymentFrequencyLabel(frequency) }}</option>
                }
              </select>
            </div>

            <div class="form-group">
              <label>D√≠a de Pago (1-31) *</label>
              <input 
                type="number" 
                [(ngModel)]="salaryForm.paymentDay" 
                name="paymentDay"
                min="1"
                max="31"
                required 
                placeholder="Ej: 1, 15, 30"
              />
              <small>D√≠a del mes en que se realizar√° el pago autom√°tico</small>
            </div>

            <div class="form-actions">
              <button type="button" class="btn-cancel" (click)="closeSalaryModal()" [disabled]="loading()">
                Cancelar
              </button>
              <button type="submit" class="btn-save" [disabled]="loading()">
                {{ loading() ? 'Guardando...' : 'Guardar' }}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  }

  <!-- Modal para historial de pagos -->
  @if (showPaymentHistoryModal()) {
    <div class="modal-overlay" (click)="closePaymentHistoryModal()">
      <div class="modal-content modal-large" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Historial de Pagos - {{ selectedEmployee()?.name }} {{ selectedEmployee()?.lastName }}</h3>
          <button class="btn-close" (click)="closePaymentHistoryModal()" aria-label="Cerrar">√ó</button>
        </div>
        <div class="modal-body">
          @if (loading() && salaryPayments().length === 0) {
            <div class="loading">Cargando historial...</div>
          } @else if (salaryPayments().length === 0) {
            <div class="no-data">No hay pagos registrados para este empleado</div>
          } @else {
            <div class="payments-table">
              <table>
                <thead>
                  <tr>
                    <th>Fecha de Pago</th>
                    <th>Per√≠odo</th>
                    <th>Monto</th>
                    <th>Frecuencia</th>
                  </tr>
                </thead>
                <tbody>
                  @for (payment of salaryPayments(); track payment.id) {
                    <tr>
                      <td>{{ formatDate(payment.paymentDate) }}</td>
                      <td>
                        {{ formatDate(payment.periodStartDate) }} - {{ formatDate(payment.periodEndDate) }}
                      </td>
                      <td class="amount-cell">{{ formatCurrency(payment.amount) }}</td>
                      <td>{{ getPaymentFrequencyLabel(payment.paymentFrequency) }}</td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          }
        </div>
        <div class="modal-actions">
          <button class="btn-cancel" (click)="closePaymentHistoryModal()">Cerrar</button>
        </div>
      </div>
    </div>
  }
</div>

